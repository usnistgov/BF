<?xml version="1.0" encoding="utf-8"?>
<BFCVE ID="CVE-2022-34835" Title="Stack Buffer Overflow in Das U-Boot through 2022.07-rc5" Description="Erroneous declaration of ‘nbytes’ as int leads to wrong argument type for the uint ‘length’ in ‘nbytes = length’, leading to a flipped sign, and under range negative ‘linebytes’, flipped and truncated to a large integer, allowing pointer reposition over bounds, which, when used in i2c_transfer() leads to stack buffer overflow. If exploited, this can lead to denial of service – program crash, and possibly arbitrary code execution.">
  <DefectWeakness Class="DCL" ClassType="_DAT">
    <Cause Comment="in 'do_i2c_md()'" Type="Code">Erroneous Code</Cause>
    <Operation Comment="int object">Declare</Operation>
    <Consequence Comment="'nbytes'" Type="Type">Wrong Type</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="'nbytes'" Type="Kind">Object</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Comment="int, while should be uint" Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Simple</Attribute>
        <Attribute Comment="u-boot/cmd/i2c.c:#L473" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  <AuxData Language="C" File="https://github.com/u-boot/u-boot/blob/b75fd37037bcca8a5e86f1648e8fb4e97cba345a/cmd/i2c.c#L473" Trace="" Line="473" /></DefectWeakness>
  <Weakness Class="TCV" ClassType="_DAT">
    <Cause Comment="in 'nbytes = length'" Type="Type">Wrong Type</Cause>
    <Operation>Coerce</Operation>
    <Consequence Comment="'length'" Type="Data">Flipped Sign</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="'length'" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Comment="uint parsed from 'i2c md 0 0 80000100' by do_i2c_md()" Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Comment="uint" Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="'length' from '=' operator, int expected" Type="Mechanism">Pass Out</Attribute>
        <Attribute Comment="u-boot/cmd/i2c.c#L531" Type="Source Code">Codebase</Attribute>
        <Attribute Comment="0x80000100 is negative on 32 bit-platform" Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  <AuxData Language="C" File="https://github.com/u-boot/u-boot/blob/b75fd37037bcca8a5e86f1648e8fb4e97cba345a/cmd/i2c.c#L531" Trace="" Line="531" /></Weakness>
  <Weakness Class="TCM" ClassType="_DAT">
    <Cause Comment="in 'linebytes = (nbytes &gt; DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes'" Type="Data">Wrong Argument</Cause>
    <Operation Comment="&gt;">Evaluate</Operation>
    <Consequence Comment="negative 'linebytes' instead of 16" Type="Data">Under Range</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="nbytes" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Comment="negative" Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="greater-than '&gt;'" Type="Mechanism">Operator</Attribute>
        <Attribute Comment="u-boot/cmd/i2c.c#L536" Type="Source Code">Codebase</Attribute>
        <Attribute Comment="linebytes is negative instead f 16" Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  <AuxData Language="C" File="https://github.com/u-boot/u-boot/blob/b75fd37037bcca8a5e86f1648e8fb4e97cba345a/cmd/i2c.c#L536" Trace="" Line="536" /></Weakness>
  <Weakness Class="TCV" ClassType="_DAT">
    <Cause Comment="in 'nx_i2c_read(uint len)'" Type="Data">Under Range</Cause>
    <Operation Comment="negative 'len'">Coerce</Operation>
    <Consequence Comment="unsigned 'len'" Type="Data">Flipped Sign</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Comment="negative &#xD;&#xA;0x80000100" Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="uint expected" Type="Mechanism">Pass In</Attribute>
        <Attribute Comment="u-boot/drivers/i2c/nx_i2c.c#L472-#L473" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  <AuxData Language="C" File="https://github.com/u-boot/u-boot/blob/b75fd37037bcca8a5e86f1648e8fb4e97cba345a/drivers/i2c/nx_i2c.c#L472-L473" Trace="" Line="472, 473" /></Weakness>
  <Weakness Class="TCV" ClassType="_DAT">
    <Cause Comment="in 'i2c_transfer()'" Type="Data">Flipped Sign</Cause>
    <Operation Comment="unsigned 'len'">Coerce</Operation>
    <Consequence Comment="large int 'len'" Type="Data">Truncated Value</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Comment="uint" Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="ushort expected" Type="Mechanism">Pass In</Attribute>
        <Attribute Comment="u-boot/drivers/i2c/nx_i2c.c#L498-#L499" Type="Source Code">Codebase</Attribute>
        <Attribute Comment="may  crash if not truncated by driver" Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  <AuxData Language="C" File="https://github.com/u-boot/u-boot/blob/b75fd37037bcca8a5e86f1648e8fb4e97cba345a/drivers/i2c/nx_i2c.c#L498-L499" Trace="" Line="498-499" /></Weakness>
  <Weakness Class="MAD" ClassType="_MEM">
    <Cause Comment="in 'data[i++] = readb(&amp;i2c-&gt;iicds);'" Type="Data">Wrong Size</Cause>
    <Operation Comment="pointer">Reposition</Operation>
    <Consequence Comment="'i'" Type="Address">Overbound Pointer</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Comment="too large for the 16-bit buffer at hand" Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Sequential</Attribute>
        <Attribute Comment="u-boot/drivers/i2c/nx_i2c.c#L499" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  <AuxData Language="C" File="https://github.com/u-boot/u-boot/blob/b75fd37037bcca8a5e86f1648e8fb4e97cba345a/drivers/i2c/nx_i2c.c#L449" Trace="" Line="449" /></Weakness>
  <Weakness Class="MUS" ClassType="_MEM">
    <Cause Comment="in 'data[i++] = readb(&amp;i2c-&gt;iicds);'" Type="Address">Overbound Pointer</Cause>
    <Operation Comment="object">Write</Operation>
    <Consequence Comment="'data[i++] '" Type="Memory Corruption/Disclosure">Buffer Overflow</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Sequential</Attribute>
        <Attribute Comment="u-boot/drivers/i2c/nx_i2c.c#L449" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  <AuxData Language="C" File="https://github.com/u-boot/u-boot/blob/b75fd37037bcca8a5e86f1648e8fb4e97cba345a/drivers/i2c/nx_i2c.c#L449" Trace="" Line="449" /></Weakness>
  <Failures ClassType="_FLR">
    <Cause Type="Memory Corruption/Disclosure">Buffer Overflow</Cause>
    <Failure Class="ACE" Comment="(everything could be lost)" />
    <Failure Class="DOS" Comment="(availability loss)" />
  </Failures>
<AuxData Author="Irena Bojanova, Eduard Pinconschi" Date="2023-10-13T14:00:14" Score="7.5" Criteria="denx:u-boot" BugReport="https://lists.denx.de/pipermail/u-boot/2022-June/486113.html" CodeWithBug="https://source.denx.de/u-boot/u-boot/-/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409" CodeWithFix="https://github.com/u-boot/u-boot/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409" CommitId="8f8c04b" /></BFCVE>